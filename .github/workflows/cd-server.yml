name: Backend Deployment

on:
  push:
  workflow_run:
    workflows: ["Backend Integration"] 
    types:
      - completed

jobs: 

  deploy:
    strategy:
      matrix:
        server: [
          SERVER_1, 
          SERVER_2, 
          SERVER_3
          ]

    runs-on: 
      - self-hosted
      - ${{ matrix.server }}

    steps:
    - run: |
        sudo chown -R $USER .
    - uses: actions/checkout@v4
      with:
        sparse-checkout: |
          ./scripts/server
          ./server-configs
          ./compose-server.yml

    - name: Delete Old Containers
      run: |
        sudo docker rm -f $(sudo docker ps -qa) || true
        sudo bash -c 'echo y | docker system prune' 

    - name: Compose Up Services 
      env:
        COMPOSE_FNAME: compose-server.yml
        CERT: ${{ secrets.CERT }}
        CERT_KEY: ${{ secrets.CERT_KEY }}
      run: | 
        touch .env.server && touch .env.proxy
        sudo bash -c 'echo "${{ secrets.SERVER_ENV }}" > .env.server'
        sudo bash -c 'echo "SERVER_NAME=${{ vars.API_DOMAIN }}" >> .env.proxy'
        chmod +x ./scripts/server/compose.sh
        ./scripts/server/compose.sh